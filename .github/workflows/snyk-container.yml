name: Snyk Container Scan (CLI)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '18 9 * * 3'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t my-node-app:latest .

      - name: Install Snyk CLI and jq
        run: |
          npm install -g snyk
          sudo apt-get update && sudo apt-get install -y jq

      - name: Authenticate Snyk
        run: snyk config set api=$SNYK_TOKEN
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk container test + export SARIF
        continue-on-error: true
        run: |
          snyk container test my-node-app:latest \
            --file=Dockerfile \
            --sarif --sarif-file-output=snyk-container-raw.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Fix SARIF security severity values
        run: |
          # Corregir valores null en security-severity
          jq '
            (.runs[].results[] | select(.properties?.security_severity? == null).properties.security_severity) = "0.0" |
            (.runs[].tool.driver.rules[] | select(.properties?.security_severity? == null).properties.security_severity) = "0.0"
          ' snyk-container-raw.sarif > snyk-container.sarif

      - name: Upload Snyk SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-container.sarif