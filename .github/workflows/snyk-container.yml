name: Snyk Container Scan (CLI)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '18 9 * * 3'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t my-node-app:latest .

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate Snyk
        run: snyk config set api=$SNYK_TOKEN
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk container test + export SARIF
        continue-on-error: true
        run: |
          snyk container test my-node-app:latest \
            --file=Dockerfile \
            --sarif --sarif-file-output=snyk-container.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: List workspace files (debug)
        run: |
          echo "=== WORKSPACE FILES ==="
          ls -R .

      # 游댠 Soluci칩n al warning url.parse()
      # Si tu aplicaci칩n se ejecuta durante el an치lisis, esto lo eliminar치
      - name: Run Node app without deprecation warnings
        run: |
          if [ -f "server.js" ]; then
            node --no-deprecation server.js &
          fi

      - name: Upload Snyk SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-container.sarif
