name: Snyk Container Scan (CLI)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '18 9 * * 3'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t my-node-app:latest .

      - name: Install Snyk CLI and jq
        run: |
          npm install -g snyk
          sudo apt-get update && sudo apt-get install -y jq

      - name: Authenticate Snyk
        run: snyk config set api=$SNYK_TOKEN
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk container test + export SARIF
        continue-on-error: true
        run: |
          # Ejecutar Snyk y verificar que el archivo se crea correctamente
          snyk container test my-node-app:latest \
            --file=Dockerfile \
            --sarif --sarif-file-output=snyk-container-raw.sarif || echo "Snyk completed with exit code: $?"
          
          # Verificar que el archivo existe y tiene contenido
          if [ -f "snyk-container-raw.sarif" ]; then
            echo "SARIF file size: $(wc -c < snyk-container-raw.sarif) bytes"
            if [ $(wc -c < snyk-container-raw.sarif) -eq 0 ]; then
              echo "ERROR: SARIF file is empty"
              exit 1
            fi
          else
            echo "ERROR: SARIF file was not created"
            exit 1
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Verify raw SARIF file
        run: |
          echo "=== Verifying raw SARIF file ==="
          if [ ! -f "snyk-container-raw.sarif" ]; then
            echo "ERROR: Raw SARIF file does not exist"
            exit 1
          fi
          
          filesize=$(wc -c < snyk-container-raw.sarif)
          echo "File size: $filesize bytes"
          
          if [ $filesize -eq 0 ]; then
            echo "ERROR: Raw SARIF file is empty"
            exit 1
          fi
          
          # Verificar que es JSON válido
          if jq empty snyk-container-raw.sarif 2>/dev/null; then
            echo "✅ Raw SARIF is valid JSON"
          else
            echo "❌ Raw SARIF is not valid JSON"
            echo "First 500 characters:"
            head -c 500 snyk-container-raw.sarif
            exit 1
          fi

      - name: Fix SARIF security severity values
        run: |
          # Script simple y robusto que garantiza JSON válido
          if jq empty snyk-container-raw.sarif 2>/dev/null; then
            jq '
            # Función simple para eliminar la propiedad problemática
            walk(if type == "object" then del(."security-severity") else . end)
            ' snyk-container-raw.sarif > snyk-container.sarif
            
            # Verificar que la transformación fue exitosa
            if [ $? -eq 0 ] && [ -s snyk-container.sarif ]; then
              echo "✅ SARIF transformation successful"
            else
              echo "❌ SARIF transformation failed"
              # Crear un SARIF básico válido como fallback
              echo '{"version":"2.1.0","runs":[]}' > snyk-container.sarif
            fi
          else
            echo "❌ Raw SARIF is invalid, creating empty SARIF"
            echo '{"version":"2.1.0","runs":[]}' > snyk-container.sarif
          fi

      - name: Validate final SARIF file
        run: |
          echo "=== Validating final SARIF file ==="
          if [ ! -f "snyk-container.sarif" ]; then
            echo "ERROR: Final SARIF file does not exist"
            exit 1
          fi
          
          filesize=$(wc -c < snyk-container.sarif)
          echo "File size: $filesize bytes"
          
          if [ $filesize -eq 0 ]; then
            echo "ERROR: Final SARIF file is empty"
            exit 1
          fi
          
          if jq empty snyk-container.sarif 2>/dev/null; then
            echo "✅ Final SARIF is valid JSON"
            echo "Basic structure:"
            jq '{version: .version, runs_count: (.runs | length)}' snyk-container.sarif
          else
            echo "❌ Final SARIF is not valid JSON"
            echo "First 200 characters:"
            head -c 200 snyk-container.sarif
            exit 1
          fi

      - name: Upload Snyk SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-container.sarif