name: Snyk Container Scan (CLI)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '18 9 * * 3'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t my-node-app:latest .

      - name: Install Snyk CLI and jq
        run: |
          npm install -g snyk
          sudo apt-get update && sudo apt-get install -y jq

      - name: Authenticate Snyk
        run: snyk config set api=$SNYK_TOKEN
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk container test + export SARIF
        continue-on-error: true
        run: |
          snyk container test my-node-app:latest \
            --file=Dockerfile \
            --sarif --sarif-file-output=snyk-container-raw.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Fix SARIF security severity values
        run: |
          # Script corregido que maneja arrays nulos
          jq '
          # Función para mapear niveles de severidad a números
          def severity_to_number:
            if . == "critical" then "9.5"
            elif . == "high" then "7.5"
            elif . == "medium" then "5.0"
            elif . == "low" then "3.0"
            else "0.0" end;

          # Asegurar que los arrays existan antes de iterar
          (.runs[] | select(.tool.driver.rules == null).tool.driver.rules) = [] |
          (.runs[] | select(.results == null).results) = [] |

          # Corregir security-severity en rules (solo si rules existe)
          (.runs[].tool.driver.rules[]? | 
            select(.properties?."security-severity"? == null) |
            .properties."security-severity" = (
              if .properties?.severity? then 
                .properties.severity | severity_to_number 
              else "0.0" end
            )
          ) |
          
          # Corregir security-severity en results (solo si results existe)
          (.runs[].results[]? | 
            select(.properties?."security-severity"? == null) |
            .properties."security-severity" = (
              if .properties?.severity? then 
                .properties.severity | severity_to_number 
              else "0.0" end
            )
          )
          ' snyk-container-raw.sarif > snyk-container.sarif

      - name: Validate SARIF file
        run: |
          echo "=== Validating SARIF file ==="
          if jq empty snyk-container.sarif 2>/dev/null; then
            echo "✅ SARIF file is valid JSON"
          else
            echo "❌ SARIF file is invalid JSON"
            exit 1
          fi

      - name: Upload Snyk SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-container.sarif